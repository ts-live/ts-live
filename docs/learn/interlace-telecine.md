## ここで使う動画

こんな感じで生成する。24fpsテレシネ化、30fpsプログレッシブ、60fpsインターレースの3種類

```bash
#!/bin/bash

function gen_dummy() {
  duration=$1
  fps=$2
  filter=$3
  filename=$4
  extra_args=$5
  frames=$(expr ${duration} \* $(echo ${fps} | sed 's|/| / |g'))
  gen="mptestsrc=duration=${duration}:max_frames=${frames}:rate=${fps}:test=mv"
  agen="anullsrc=duration=${duration}"
  resize="crop=w=256:h=240:x=0:y=0,scale=w=1440:h=1080"

  # onid/tsid/sidは後で書き換えるので適当な値でOK
  ffmpeg -hide_banner \
    -f lavfi -i "${gen}" \
    -f lavfi -i "${agen}" \
    -vf "${resize},${filter},fps=fps=30000/1001" \
    -pix_fmt yuv420p \
    -c:v mpeg2video \
    -c:a aac \
    -f mpegts \
    -mpegts_original_network_id 0x1122 \
    -mpegts_transport_stream_id 0x3344 \
    -mpegts_service_id 0x5566 \
    -metadata service_provider="MyProvider" \
    -metadata service_name="MyChannel" \
    -mpegts_flags +nit \
    -mpegts_m2ts_mode 0 \
    -nit_period 1 \
    ${extra_args} \
    "${filename}" \
    -y
}

duration=300

gen_dummy ${duration} 24 "telecine=first_field=top:pattern=23" 24t.ts "-flags +ilme+ildct"
gen_dummy ${duration} 30 "null"  30p.ts ""
gen_dummy ${duration} 60 "interlace"  60i.ts "-flags +ilme+ildct"
```

## 動画の説明

横方向の白いバーが右から左へ縮んでいくのを繰り返している。
イメージとしてはテキストで書くとこんな感じ。
a:32～a:22として表記する（actual widthみたいな意味）
t:とb:でtop-fieldとbottom-fieldのwidthを表す。
24fpsテレシネ・30fpsプログレッシブ・60fpsインターレースでそれぞれ実時間での移動速度は違うが、フレームとしては進み方が一緒になるようにした。

frame0
```plaintext
*******************************
*******************************
*******************************
*******************************
*******************************
*******************************
```

frame1
```plaintext
*****************************
*****************************
*****************************
*****************************
*****************************
*****************************
```

frame2
```plaintext
***************************
***************************
***************************
***************************
***************************
***************************
```

frame3
```plaintext
*************************
*************************
*************************
*************************
*************************
*************************
```


## インターレース

Top Field Firstで考えると、こんな風に格納されている。

frame0
```plaintext
*******************************
*****************************
*******************************
*****************************
*******************************
*****************************
```

t:32
b:30

a:32とa:30の2フレーム分を重ねてるようなイメージなので、t->bの順番で表示（残りは補完）すると良い

frame1
```plaintext
***************************
*************************
***************************
*************************
***************************
*************************
```

t:28
b:26

a:28とa:26


frame2
```plaintext
***********************
*********************
***********************
*********************
***********************
*********************
```

t:24
b:22

a:24とa:22

frame3
```plaintext
*******************
*****************
*******************
*****************
*******************
*****************
```

t:20
b:18
a:20とa:18

frame0-top -> frame0-bottom -> frame1-top -> frame1-bottom -> frame2-top -> frame2-bottom -> frame3-top -> frame3-bottom
というような順番で表示していくと60fpsになる（解像度は半分）



## テレシネ

frame:-2
```plaintext
*********************************
*********************************
*********************************
*********************************
*********************************
*********************************
```

a:34
t:34
b:34
そのまま表示すれば良い

frame:-1(modulo = 4)
```plaintext
*******************************
*******************************
*******************************
*******************************
*******************************
*******************************
```

a:32
t:32
b:32
そのまま表示すれば良い
topを補完するとt:34とt:32でt:33が補完されてしまうので、ここはあえてbottomを補完する


frame0(repeated-top)
```plaintext
*******************************
*****************************
*******************************
*****************************
*******************************
*****************************
```

a:30
t:32
b:30

top-fieldが無い（前のフレームのまま）のでyadifでtop-fieldを補完する。
前のフレームのt:32と次のフレームのt:28でt:30が補完されるのでOK

frame1
```plaintext
***************************
*************************
***************************
*************************
***************************
*************************
```

a:28
t:28
b:26
bottom-fieldがいきすぎてるのでyadifでbottom-fieldを補完すると画像が出来る、が、どうせ次のフレームで
全部来るからこのフレームをスキップして良い。


frame2(repeated-bottom)
```plaintext
*************************
*************************
*************************
*************************
*************************
*************************
```

a:26
t:26
b:26
そのまま表示すれば良い
yadifにかけてtopを補完すると前のフレームt:28と次のフレームt:24でt:26が補完されるのでOK


frame3
```plaintext
***********************
***********************
***********************
***********************
***********************
***********************
```

a:24
t:24
b:24
そのまま表示すれば良い

frame3
```plaintext
*********************
*********************
*********************
*********************
*********************
*********************
```

a:22
t:22
b:22
そのまま表示すれば良い


frame4
```plaintext
*******************
*******************
*******************
*******************
*******************
*******************
```

a:20
t:20
b:20
frame-1と同じでbottomを補完する


repeated-topとrepeated-bottomでそれぞれ奇数・偶数行が前のフレームのままになっている。
repeated-topとrepeated-bottomの間のフレームはズレたまま進む


「そのまま表示」としたが、実際は判定ミスなどが起こり、周期とズレることがあり、そのときにそのまま表示してしまうと5フレーム中2枚はコーミングが起きる。そこで、そのまま表示するのではなくyadifで補完する。repeated-topと同じくtop-fieldを補完すればいいか？

### フレームを落としたときの対処

ストリーム上のフレームのPTSは、分かりやすいように24と30の最小公倍数の120を分母として表現すると、

|frame|PTS|
|---|---|
|frame0|0|
|frame1|4|
|frame2|8|
|frame3|12|
|frame4|16|
|frame5|20|
|frame6|24|
|frame7|28|
|frame8|32|
|frame9|36|

と並んでいる

これをframe2、frame7をスキップするので、frame2を基準の0とすると、
|frame|PTS(30fps)|PTS(24fps)|
|---|---|--|
|frame0|-8|?|
|frame1|-4|?|
|frame2|0|(skip)|
|frame3|4|0|
|frame4|8|5|
|frame5|12|10|
|frame6|16|15|
|frame7|20|(skip)|
|frame8|24|20|
|frame9|28|25|

と並んでいるので、30fpsのPTSの差分値Xに対して
frame3: PTS = PTS - 4 * X/4（frame2のPTSと同じ）
frame4: PTS = PTS - 3 * X/4
frame5: PTS = PTS - 2 * X/4 
frame6: PTS = PTS - 1 * X/4
frame7: (skip)

という風に補正していけば良い


### WebGPUでの対応

yadifの実装はprev-cur-nextの3フレームを見るため、1フレームずれて考える必要がある。
